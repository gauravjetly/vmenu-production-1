# VMenu Deployment Guide

This guide covers deploying VMenu to AWS using GitHub Actions CI/CD and Terraform infrastructure.

## Prerequisites

1. AWS Account with appropriate permissions
2. GitHub repository with secrets configured
3. Domain name with SSL certificate
4. Terraform installed locally (for initial setup)

## Required GitHub Secrets

Configure these secrets in your GitHub repository settings:

- `AWS_ACCESS_KEY_ID` - AWS access key for deployments
- `AWS_SECRET_ACCESS_KEY` - AWS secret access key
- `DATABASE_URL` - PostgreSQL connection string (will be generated by Terraform)
- `REDIS_URL` - Redis connection string (will be generated by Terraform)
- `JWT_SECRET` - Secret for JWT token generation
- `JWT_REFRESH_SECRET` - Secret for JWT refresh token generation
- `AWS_S3_BUCKET` - S3 bucket name for uploads
- `VITE_API_URL` - Frontend API URL (e.g., https://api.yourdomain.com)
- `VITE_WS_URL` - WebSocket URL (e.g., wss://api.yourdomain.com/ws)
- `SLACK_WEBHOOK` - (Optional) Slack webhook for deployment notifications

## Infrastructure Setup

### 1. Initialize Terraform State Bucket

```bash
# Create S3 bucket for Terraform state
aws s3 mb s3://vmenu-terraform-state --region us-east-1

# Create DynamoDB table for state locking
aws dynamodb create-table \
    --table-name vmenu-terraform-locks \
    --attribute-definitions AttributeName=LockID,AttributeType=S \
    --key-schema AttributeName=LockID,KeyType=HASH \
    --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
    --region us-east-1
```

### 2. Deploy Infrastructure

```bash
cd infrastructure/terraform

# Initialize Terraform
terraform init

# Create terraform.tfvars file
cat > terraform.tfvars <<EOF
db_password = "your-secure-database-password"
certificate_arn = "arn:aws:acm:us-east-1:YOUR_ACCOUNT:certificate/YOUR_CERT_ID"
jwt_secret = "your-jwt-secret"
jwt_refresh_secret = "your-jwt-refresh-secret"
EOF

# Plan deployment
terraform plan

# Apply infrastructure
terraform apply
```

### 3. Note Terraform Outputs

After successful deployment, note these outputs:
- ALB DNS name
- RDS endpoint
- Redis endpoint
- S3 bucket name
- ECR repository URLs

## Local Development

### Start Services Locally

```bash
# For vmenu-production
cd vmenu-production
docker-compose up -d

# For tv-menu-designer
cd tv-menu-designer
npm install
npm run dev
```

### Stop Services

```bash
# For vmenu-production
cd vmenu-production
docker-compose down

# For tv-menu-designer (Ctrl+C to stop)
```

## Deployment Process

### Automatic Deployment

Deployments are triggered automatically:
- Push to `main` branch → Production deployment
- Push to `develop` branch → Build and push images only
- Pull requests → Run tests only

### Manual Deployment

To trigger a manual deployment:

```bash
# Tag a release
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0
```

## Monitoring and Logs

### View Application Logs

```bash
# Backend logs
aws logs tail /ecs/vmenu/backend --follow

# Frontend logs
aws logs tail /ecs/vmenu/frontend --follow

# WebSocket logs
aws logs tail /ecs/vmenu/websocket --follow
```

### View ECS Service Status

```bash
# List services
aws ecs list-services --cluster vmenu-cluster

# Describe service
aws ecs describe-services \
    --cluster vmenu-cluster \
    --services vmenu-backend-service
```

## Database Management

### Connect to RDS

```bash
# Get RDS endpoint from Terraform output
PGPASSWORD=your-password psql \
    -h your-rds-endpoint.amazonaws.com \
    -U vmenu_user \
    -d vmenu_db
```

### Run Migrations

```bash
# SSH into backend container
aws ecs execute-command \
    --cluster vmenu-cluster \
    --task <task-id> \
    --container backend \
    --interactive \
    --command "/bin/sh"

# Inside container
npm run migrate:latest
```

## Troubleshooting

### Common Issues

1. **ECS Tasks Not Starting**
   - Check CloudWatch logs
   - Verify security groups
   - Check task definition environment variables

2. **Database Connection Issues**
   - Verify RDS security group allows ECS access
   - Check DATABASE_URL format
   - Ensure RDS is in same VPC

3. **S3 Upload Issues**
   - Verify IAM role permissions
   - Check S3 bucket policy
   - Ensure CORS is configured

### Debug Commands

```bash
# Check ECS task status
aws ecs describe-tasks \
    --cluster vmenu-cluster \
    --tasks <task-arn>

# View security groups
aws ec2 describe-security-groups \
    --group-ids <security-group-id>

# Test ALB health
curl https://your-alb-dns.amazonaws.com/health
```

## Rollback Procedure

To rollback to a previous version:

1. Find previous task definition revision
```bash
aws ecs list-task-definitions \
    --family-prefix vmenu-backend-task
```

2. Update service with previous revision
```bash
aws ecs update-service \
    --cluster vmenu-cluster \
    --service vmenu-backend-service \
    --task-definition vmenu-backend-task:PREVIOUS_REVISION
```

## Cost Optimization

- Use FARGATE_SPOT for non-critical services
- Enable auto-scaling based on CPU/memory metrics
- Use CloudFront for static assets
- Configure S3 lifecycle policies for old uploads

## Security Best Practices

1. Regularly rotate secrets in SSM Parameter Store
2. Enable AWS GuardDuty for threat detection
3. Use AWS WAF for application firewall
4. Enable VPC Flow Logs
5. Regular security audits with AWS Security Hub